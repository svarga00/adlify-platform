<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Marketingov√° ponuka - Adlify</title>
  <link rel="icon" href="/admin/favicon.ico">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; min-height: 100vh; }
    
    .loading { display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 1rem; }
    .loading .spinner { width: 50px; height: 50px; border: 4px solid #e2e8f0; border-top-color: #f97316; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .error-page, .success-page { display: flex; align-items: center; justify-content: center; min-height: 100vh; flex-direction: column; gap: 1rem; text-align: center; padding: 2rem; }
    .error-page h1 { font-size: 4rem; color: #f97316; }
    .success-page h1 { font-size: 4rem; }
    .error-page p, .success-page p { color: #64748b; max-width: 400px; }
    .error-page a, .success-page a { color: #f97316; text-decoration: none; font-weight: 600; }
    .error-page a:hover, .success-page a:hover { text-decoration: underline; }
    
    .proposal-container { max-width: 100%; padding-bottom: 100px; }
    
    /* Floating Action Bar - Minimal Modern Style */
    .action-bar {
      position: fixed;
      bottom: 24px;
      right: 24px;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.12), 0 0 0 1px rgba(0,0,0,0.05);
      z-index: 1000;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    
    .action-bar.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    
    .action-bar button {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    .action-bar .btn-main {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      font-weight: 600;
      padding: 12px 20px;
    }
    .action-bar .btn-main:hover {
      box-shadow: 0 4px 12px rgba(34,197,94,0.4);
      transform: translateY(-1px);
    }
    
    .action-bar .btn-secondary {
      background: #f1f5f9;
      color: #475569;
    }
    .action-bar .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .action-bar .btn-subtle {
      background: transparent;
      color: #94a3b8;
      padding: 10px 12px;
    }
    .action-bar .btn-subtle:hover {
      color: #ef4444;
      background: #fef2f2;
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      padding: 1rem;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.active { display: flex; }
    
    .modal-box {
      background: white;
      border-radius: 20px;
      max-width: 480px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: modalIn 0.3s ease;
    }
    
    @keyframes modalIn {
      from { opacity: 0; transform: scale(0.95) translateY(10px); }
      to { opacity: 1; transform: scale(1) translateY(0); }
    }
    
    .modal-header {
      background: linear-gradient(135deg, #f97316, #ec4899);
      color: white;
      padding: 1.5rem;
      border-radius: 20px 20px 0 0;
    }
    .modal-header h2 { font-size: 1.4rem; margin-bottom: 0.25rem; }
    .modal-header p { opacity: 0.9; font-size: 0.9rem; }
    .modal-body { padding: 1.5rem; }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 500; margin-bottom: 0.5rem; color: #334155; font-size: 0.9rem; }
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.2s;
    }
    .form-group input:focus, .form-group textarea:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-hint { font-size: 0.8rem; color: #94a3b8; margin-top: 0.25rem; }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.95rem;
    }
    .btn-cancel { background: #f1f5f9; color: #64748b; }
    .btn-cancel:hover { background: #e2e8f0; }
    .btn-submit { background: linear-gradient(135deg, #f97316, #ea580c); color: white; }
    .btn-submit:hover { box-shadow: 0 4px 15px rgba(249,115,22,0.3); }
    .btn-submit:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-submit-green { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
    .btn-submit-green:hover { box-shadow: 0 4px 15px rgba(34,197,94,0.3); }
    
    /* Choice buttons for "not interested" */
    .choice-buttons { display: flex; flex-direction: column; gap: 0.75rem; }
    .choice-btn {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      padding: 1rem 1.25rem;
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      background: white;
      cursor: pointer;
      transition: all 0.2s;
      text-align: left;
    }
    .choice-btn:hover { border-color: #94a3b8; background: #f8fafc; }
    .choice-icon { font-size: 1.25rem; margin-bottom: 0.25rem; }
    .choice-title { font-weight: 600; color: #1e293b; font-size: 0.95rem; }
    .choice-desc { font-size: 0.8rem; color: #64748b; margin-top: 0.125rem; }
    .choice-later:hover { border-color: #f97316; background: #fff7ed; }
    .choice-never:hover { border-color: #ef4444; background: #fef2f2; }
    
    @media print {
      .action-bar, .modal-overlay { display: none !important; }
      .proposal-container { padding-bottom: 0; }
    }
    
    @media (max-width: 768px) {
      .action-bar {
        bottom: 16px;
        right: 16px;
        left: 16px;
        justify-content: center;
        flex-wrap: wrap;
      }
      .action-bar button { 
        padding: 10px 14px;
        font-size: 0.8rem;
      }
      .action-bar .btn-main {
        order: -1;
        flex: 1 1 100%;
        margin-bottom: 4px;
      }
      .action-bar .btn-subtle {
        order: 10;
        flex: 1 1 100%;
        margin-top: 4px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      <p>Naƒç√≠tavam ponuku...</p>
    </div>
  </div>

  <!-- Modal: M√°m z√°ujem -->
  <div class="modal-overlay" id="modal-interested">
    <div class="modal-box">
      <div class="modal-header">
        <h2>üéâ M√°m z√°ujem o spolupr√°cu!</h2>
        <p>Vypl≈àte kontaktn√© √∫daje a ozveme sa v√°m</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Va≈°e meno *</label>
          <input type="text" id="interested-name" placeholder="J√°n Nov√°k" required>
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="interested-email" placeholder="jan@firma.sk" required>
        </div>
        <div class="form-group">
          <label>Telef√≥n</label>
          <input type="tel" id="interested-phone" placeholder="+421 9XX XXX XXX">
          <p class="form-hint">Pre r√Ωchlej≈°iu komunik√°ciu</p>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal('interested')">Zru≈°i≈•</button>
        <button class="btn btn-submit-green" id="btn-submit-interested" onclick="submitInterested()">‚úì Odosla≈•</button>
      </div>
    </div>
  </div>

  <!-- Modal: M√°m ot√°zky -->
  <div class="modal-overlay" id="modal-question">
    <div class="modal-box">
      <div class="modal-header">
        <h2>‚ùì M√°m ot√°zku</h2>
        <p>Nap√≠≈°te n√°m a radi odpovieme</p>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Va≈°a ot√°zka *</label>
          <textarea id="question-message" placeholder="Nap√≠≈°te va≈°u ot√°zku..." required></textarea>
        </div>
        <div class="form-group">
          <label>Va≈°e meno</label>
          <input type="text" id="question-name" placeholder="J√°n Nov√°k">
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" id="question-email" placeholder="jan@firma.sk" required>
          <p class="form-hint">Na tento email v√°m odpovieme</p>
        </div>
        <div class="form-group">
          <label>Telef√≥n</label>
          <input type="tel" id="question-phone" placeholder="+421 9XX XXX XXX">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal('question')">Zru≈°i≈•</button>
        <button class="btn btn-submit" id="btn-submit-question" onclick="submitQuestion()">üì§ Odosla≈•</button>
      </div>
    </div>
  </div>

  <!-- Modal: Nem√°m z√°ujem -->
  <div class="modal-overlay" id="modal-notinterested">
    <div class="modal-box">
      <div class="modal-header" style="background: linear-gradient(135deg, #64748b, #475569);">
        <h2>ü§î Nem√°te z√°ujem?</h2>
        <p>Nevad√≠, re≈°pektujeme va≈°e rozhodnutie</p>
      </div>
      <div class="modal-body">
        <p style="margin-bottom: 1.25rem; color: #64748b;">M√¥≈æeme v√°s oslovi≈• v bud√∫cnosti?</p>
        
        <div class="choice-buttons">
          <button class="choice-btn choice-later" onclick="submitNotInterested('later')">
            <span class="choice-icon">‚è∞</span>
            <span class="choice-title">Oslovte ma nesk√¥r</span>
            <span class="choice-desc">Teraz to nie je aktu√°lne, ale v bud√∫cnosti mo≈æno</span>
          </button>
          
          <button class="choice-btn choice-never" onclick="submitNotInterested('never')">
            <span class="choice-icon">üö´</span>
            <span class="choice-title">Nekontaktujte ma</span>
            <span class="choice-desc">Nem√°m z√°ujem o tieto slu≈æby</span>
          </button>
        </div>
        
        <div class="form-group" style="margin-top: 1.25rem;">
          <label>D√¥vod (voliteƒæn√©)</label>
          <textarea id="notinterested-reason" placeholder="ƒåo v√°s odradilo?" rows="2"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-cancel" onclick="closeModal('notinterested')">‚Üê Sp√§≈•</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Global variables
    let proposalToken = null;
    let proposalData = null;
    
    const SUPABASE_URL = 'https://eidkljfaeqvvegiponwl.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVpZGtsamZhZXF2dmVnaXBvbndsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY4NTgzNjgsImV4cCI6MjA4MjQzNDM2OH0.jFJe_IddYNiO-TOAdxhPSYtSQJlx4i6CFflB0CN4AIQ';
    
    const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    async function loadProposal() {
      const app = document.getElementById('app');
      
      // Get token from URL
      const urlParams = new URLSearchParams(window.location.search);
      proposalToken = urlParams.get('t') || urlParams.get('token');
      
      if (!proposalToken) {
        showError('Ch√Ωba token ponuky', 'Odkaz na ponuku nie je platn√Ω.');
        return;
      }
      
      console.log('Loading proposal with token:', proposalToken);
      
      try {
        // Fetch proposal
        const { data: proposal, error } = await db
          .from('proposals')
          .select('*')
          .eq('token', proposalToken)
          .single();
        
        console.log('Proposal result:', { proposal, error });
        
        if (error) {
          console.error('DB Error:', error);
          showError('Ponuka nen√°jden√°', 'T√°to ponuka neexistuje alebo jej platnos≈• vypr≈°ala.');
          return;
        }
        
        if (!proposal) {
          showError('Ponuka nen√°jden√°', 'T√°to ponuka neexistuje.');
          return;
        }
        
        proposalData = proposal;
        
        // Check expiration
        if (proposal.expires_at && new Date(proposal.expires_at) < new Date()) {
          showError('Ponuka vypr≈°ala', 'Platnos≈• tejto ponuky u≈æ vypr≈°ala. Kontaktujte n√°s pre nov√∫ ponuku.');
          return;
        }
        
        // Increment views
        try {
          await db.rpc('increment_proposal_views', { proposal_token: proposalToken });
        } catch (e) {
          console.warn('Could not increment views:', e);
        }
        
        // Render proposal
        app.innerHTML = `
          <div class="proposal-container">
            ${proposal.html_content}
          </div>
          <div class="action-bar" id="action-bar">
            <button class="btn-main" onclick="openModal('interested')">
              ‚úì M√°m z√°ujem
            </button>
            <button class="btn-secondary" onclick="openModal('question')">
              ‚ùì Ot√°zka
            </button>
            <button class="btn-secondary" onclick="window.print()">
              üìÑ PDF
            </button>
            <button class="btn-subtle" onclick="openModal('notinterested')">
              ‚úï Nem√°m z√°ujem
            </button>
          </div>
        `;
        
        // Update page title
        document.title = 'Ponuka pre ' + (proposal.company_name || 'V√°s') + ' - Adlify';
        
        // Setup scroll listener for action bar
        setupScrollListener();
        
      } catch (err) {
        console.error('Load proposal error:', err);
        showError('Chyba', 'Nepodarilo sa naƒç√≠ta≈• ponuku. Sk√∫ste to znova nesk√¥r.');
      }
    }
    
    function setupScrollListener() {
      const actionBar = document.getElementById('action-bar');
      if (!actionBar) return;
      
      let ticking = false;
      
      function updateActionBar() {
        const scrollY = window.scrollY;
        const viewportHeight = window.innerHeight;
        
        // Show after scrolling 400px or 50% of viewport (whichever is less)
        const showThreshold = Math.min(400, viewportHeight * 0.5);
        
        if (scrollY > showThreshold) {
          actionBar.classList.add('visible');
        } else {
          actionBar.classList.remove('visible');
        }
        
        ticking = false;
      }
      
      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(updateActionBar);
          ticking = true;
        }
      });
      
      // Initial check after small delay
      setTimeout(updateActionBar, 500);
    }
    
    function showError(title, message) {
      document.getElementById('app').innerHTML = `
        <div class="error-page">
          <h1>üòï</h1>
          <h2>${title}</h2>
          <p>${message}</p>
          <a href="https://adlify.eu">Nav≈°t√≠vi≈• adlify.eu ‚Üí</a>
        </div>
      `;
    }
    
    function showSuccess(title, message) {
      document.getElementById('app').innerHTML = `
        <div class="success-page">
          <h1>üéâ</h1>
          <h2>${title}</h2>
          <p>${message}</p>
          <br>
          <p><strong>Adlify t√≠m</strong></p>
          <p>üìß info@adlify.eu</p>
          <p>üìû +421 944 184 045</p>
          <br>
          <a href="https://adlify.eu">Nav≈°t√≠vi≈• adlify.eu ‚Üí</a>
        </div>
      `;
      // Hide action bar
      const actionBar = document.getElementById('action-bar');
      if (actionBar) actionBar.style.display = 'none';
    }
    
    function openModal(type) {
      document.getElementById('modal-' + type).classList.add('active');
    }
    
    function closeModal(type) {
      document.getElementById('modal-' + type).classList.remove('active');
    }
    
    async function submitInterested() {
      const name = document.getElementById('interested-name').value.trim();
      const email = document.getElementById('interested-email').value.trim();
      const phone = document.getElementById('interested-phone').value.trim();
      
      if (!name || !email) {
        alert('Vypl≈àte pros√≠m meno a email.');
        return;
      }
      
      const btn = document.getElementById('btn-submit-interested');
      btn.disabled = true;
      btn.textContent = '‚è≥ Odosielam...';
      
      try {
        const response = await fetch('/.netlify/functions/proposal-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: proposalToken,
            action: 'interested',
            contactName: name,
            contactEmail: email,
            contactPhone: phone
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          closeModal('interested');
          showSuccess('ƒéakujeme za v√°≈° z√°ujem!', 'ƒåoskoro v√°s budeme kontaktova≈• s ƒèal≈°√≠mi krokmi spolupr√°ce.');
        } else {
          throw new Error(result.error || 'Nepodarilo sa odosla≈•');
        }
      } catch (err) {
        console.error('Submit error:', err);
        alert('Chyba pri odosielan√≠. Sk√∫ste to znova alebo n√°s kontaktujte na info@adlify.eu');
        btn.disabled = false;
        btn.textContent = '‚úì Odosla≈•';
      }
    }
    
    async function submitQuestion() {
      const message = document.getElementById('question-message').value.trim();
      const name = document.getElementById('question-name').value.trim();
      const email = document.getElementById('question-email').value.trim();
      const phone = document.getElementById('question-phone').value.trim();
      
      if (!message || !email) {
        alert('Vypl≈àte pros√≠m ot√°zku a email.');
        return;
      }
      
      const btn = document.getElementById('btn-submit-question');
      btn.disabled = true;
      btn.textContent = '‚è≥ Odosielam...';
      
      try {
        const response = await fetch('/.netlify/functions/proposal-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: proposalToken,
            action: 'question',
            message: message,
            contactName: name,
            contactEmail: email,
            contactPhone: phone
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          closeModal('question');
          showSuccess('ƒéakujeme za va≈°u ot√°zku!', 'Odpovieme v√°m ƒço najsk√¥r na ' + email);
        } else {
          throw new Error(result.error || 'Nepodarilo sa odosla≈•');
        }
      } catch (err) {
        console.error('Submit error:', err);
        alert('Chyba pri odosielan√≠. Sk√∫ste to znova alebo n√°s kontaktujte na info@adlify.eu');
        btn.disabled = false;
        btn.textContent = 'üì§ Odosla≈•';
      }
    }
    
    async function submitNotInterested(type) {
      const reason = document.getElementById('notinterested-reason').value.trim();
      
      // Disable buttons
      document.querySelectorAll('.choice-btn').forEach(btn => {
        btn.disabled = true;
        btn.style.opacity = '0.5';
        btn.style.pointerEvents = 'none';
      });
      
      try {
        const response = await fetch('/.netlify/functions/proposal-response', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token: proposalToken,
            action: 'not_interested',
            subType: type,
            reason: reason
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          closeModal('notinterested');
          if (type === 'later') {
            showSuccess('ƒéakujeme za sp√§tn√∫ v√§zbu!', 'Budeme v√°s kontaktova≈• nesk√¥r. Dr≈æ√≠me palce!');
          } else {
            showSuccess('Rozumieme, ƒèakujeme!', 'Va≈°a po≈æiadavka bola zaznamenan√°. Prajem veƒæa √∫spechov!');
          }
        } else {
          throw new Error(result.error || 'Nepodarilo sa odosla≈•');
        }
      } catch (err) {
        console.error('Submit error:', err);
        alert('Chyba pri odosielan√≠.');
        document.querySelectorAll('.choice-btn').forEach(btn => {
          btn.disabled = false;
          btn.style.opacity = '1';
          btn.style.pointerEvents = 'auto';
        });
      }
    }
    
    // Close modal on outside click - using event delegation
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal-overlay')) {
        e.target.classList.remove('active');
      }
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal-overlay.active').forEach(modal => {
          modal.classList.remove('active');
        });
      }
    });
    
    // Load on page ready
    loadProposal();
  </script>
</body>
</html>
